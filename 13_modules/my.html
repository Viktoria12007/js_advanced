<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>TODO</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" 
    rel="stylesheet" 
    integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" 
    crossorigin="anonymous">
    <script>
      document.addEventListener("DOMContentLoaded", () => alert('page loaded'));
    </script>
    <script type="module">
        const owner = 'Я';
        const container = document.getElementById('todo-app');
        let data = localStorage.getItem('Хранилище') ? JSON.parse(localStorage.getItem('Хранилище')) : 'local';
        
        if (!localStorage.getItem('Хранилище')) {
        (async () => {
         chooseStorage({localAction: callLocalStorage, serverAction: callServerStorage});
            }) ();
        }

        if (localStorage.getItem('Хранилище')) {
            chooseStorage({localAction: callLocalStorage, serverAction: callServerStorage});
            }
 
 async function callServerStorage() {

    while (container.firstChild) {
      container.removeChild(container.firstChild);
    }
          
    let {createTodoApp} = await import('./todo-app-server/view.js');
    let {
    getTodoList,
    createTodoItem,
    switchTodoItemDone,
    deleteTodoItem} = await import('./todo-app-server/api.js');
  
 
    (async () => {
        const todoItemList = await getTodoList(owner);
        createTodoApp(document.getElementById('todo-app'), {
        title: 'Мои дела', 
        owner,
        todoItemList, 
        onCreateFormSubmit: createTodoItem,
        onDoneClick: switchTodoItemDone,
        onDeleteClick: deleteTodoItem
    });  
    }) ();
    
    switchStorageButton.textContent = 'Перейти на локальное хранилище';
    localStorage.setItem('Хранилище', JSON.stringify('server'));
}

async function callLocalStorage() {

        while (container.firstChild) {
          container.removeChild(container.firstChild);
        }
        
        let {createTodoApp} = await import('./todo-app-local/view.js');
        let {
        setMemory,
        getTodoList,
        createTodoItem,
        switchTodoItemDone,
        deleteTodoItem} = await import('./todo-app-local/api.js');
  
        
       createTodoApp(document.getElementById('todo-app'), 'Мои дела', owner,
       {
       setMemory: setMemory,
       getTodoList: getTodoList,
       createTodoItem: createTodoItem,
       switchTodoItemDone: switchTodoItemDone,
       deleteTodoItem: deleteTodoItem});

       switchStorageButton.textContent = 'Перейти на серверное хранилище';
       localStorage.setItem('Хранилище', JSON.stringify('local'));

}
            
 function chooseStorage({localAction, serverAction}) {
      
      if (data === 'local') {
        localAction();
     }
      if (data === 'server') {
        serverAction(); 
     }

 
}
      
      const switchStorageButton = document.querySelector('.js-switch-storage');
      switchStorageButton.addEventListener('click', async (e) => {
      e.preventDefault();
      data = localStorage.getItem('Хранилище') ? JSON.parse(localStorage.getItem('Хранилище')) : 'local';
     chooseStorage({localAction: callServerStorage, serverAction: callLocalStorage});
      });
      
    </script>
</head>
<body>
    <div class="container mb-5">
    <nav class="nav">
        <a class="nav-link" href="my.html">Мои дела</a>
        <a class="nav-link" href="dad.html">Дела папы</a>
        <a class="nav-link" href="mom.html">Дела мамы</a>
    </nav>
    </div>
    <div class="d-flex justify-content-center">
    <button class="js-switch-storage btn btn-outline-primary text-center mb-5">Перейти на серверное хранилище</button>
    </div>
    <div id="todo-app" class="container d-flex flex-column align-items-center"></div>
</body>
</html>